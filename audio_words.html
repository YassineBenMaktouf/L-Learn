{% extends "mainfront/base.html" %}

{% block content %}
<div class="row justify-content-center mt-3">
  <div class="col-lg-6 col-md-8 col-sm-10">
      <div class="card mb-2">
          <div class="card-body" >
              <div class="page">
                  <div class="container py-5">
                      <div class="row">
                          <div class="col">
                              <h2 class="card-title text-center mb-4">Listen carfully and chose the right word:</h2>
                              <div id="wordfortts" style="display: none;"></div>
                              <div class="mt-4 mb-4 d-flex justify-content-center">
                                  <img src="static/img/audio.png" class="img-fluid w-100 rounded" alt="Img" style="max-width: 140px;">
                              </div>
                              <div  class="mt-4 mb-4 d-flex justify-content-center">
                                <button class="btn btn-secondary btn-lg btn-block mr-4 " onclick="readAloud('wordfortts','en-US',1)" style="margin: 3px;">üéß</button>
                                <button class="btn btn-secondary btn-lg btn-block ml-4" onclick="readAloud('wordfortts','en-US',0.5)" style="margin: 3px;">üê¢</button>
                              </div>
                              <div  class="mt-4 mb-4 d-flex justify-content-center">
                                  <button id="word1fortts" class="btn btn-primary btn-block mr-2" style="margin: 3px;">Loading..</button>
                                  <button id="word2fortts" class="btn btn-primary btn-block mr-2" style="margin: 3px;">Loading..</button>
                                  <button id="word3fortts" class="btn btn-primary btn-block mr-2" style="margin: 3px;">Loading..</button>
                                  <button id="word4fortts" class="btn btn-primary btn-block mr-2" style="margin: 3px;">Loading..</button>
                              </div>
                              <div>
                                  <div id="feedback" class="mt-3 d-flex align-items-center justify-content-center" style="text-align: center;"></div>
                              </div>
                              <div class="mt-3 d-flex justify-content-center">
                                  <button id="nextWord" class="btn btn-secondary" style="display: none;" onclick="nextWord()">Next Word</button>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
          </div>
      </div>
  </div>
</div>
<script>
function readAloud(elementId, language = 'en-US', speed = 1) {
    const text = document.getElementById(elementId).innerText;
    if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = language;
        utterance.rate = speed;
        let voices = window.speechSynthesis.getVoices();
        if (voices.length > 0) {
            let voice = voices.find(voice => voice.lang === language);
            if (voice) utterance.voice = voice;
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(utterance);
        } else {
            window.speechSynthesis.onvoiceschanged = function() {
                voices = window.speechSynthesis.getVoices();
                let voice = voices.find(voice => voice.lang === language);
                if (voice) utterance.voice = voice;
                window.speechSynthesis.cancel();
                window.speechSynthesis.speak(utterance);
            };
        }
    } else {
        alert("Your browser doesn't support text-to-speech. Please use a supported browser.");
    }
}

let incorrectAttempts = 0;
const maxIncorrectAttempts = 2;

function generateWordsForTTS() {
    incorrectAttempts = 0;
    disableWordButtons(true);
    fetch('/generate_words_for_tts')
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.words && data.words.length > 0 && data.correct_word) {
                updateButtons(data.words, data.correct_word);
                document.getElementById('wordfortts').innerText = data.correct_word;
                document.getElementById('nextWord').style.display = 'none';
            } else {
                console.error('Failed to generate words');
                document.getElementById('feedback').innerText = 'Failed to generate words.';
                document.getElementById('feedback').classList.add('text-danger');
                document.getElementById('feedback').classList.remove('text-success');
            }
        })
        .catch(error => {
            console.error('Error occurred during fetch:', error);
            document.getElementById('feedback').innerText = 'Error fetching words.';
            document.getElementById('feedback').classList.add('text-danger');
            document.getElementById('feedback').classList.remove('text-success');
        });
}
function updateButtons(words, correctWord) {
    const buttonIds = ['word1fortts', 'word2fortts', 'word3fortts', 'word4fortts'];
    words.forEach((word, index) => {
        const button = document.getElementById(buttonIds[index]);
        button.innerText = word;
        button.disabled = false;
        button.onclick = function() { checkAnswer(word, correctWord); };
    });
}
function checkAnswer(selectedWord, correctWord) {
    if (selectedWord === correctWord) {
        document.getElementById('feedback').innerText = 'Correct!';
        document.getElementById('feedback').classList.add('text-success');
        document.getElementById('feedback').classList.remove('text-danger');
        document.getElementById('nextWord').style.display = 'block';
        updatePoints();
        disableWordButtons(true);
    } else {
        handleIncorrectAnswerForWord(correctWord);
    }
}
function handleIncorrectAnswerForWord(correctWord) {
    incorrectAttempts += 1;
    if (incorrectAttempts >= maxIncorrectAttempts) {
        document.getElementById('feedback').innerText = `Incorrect! The correct word was: ${correctWord}.`;
        document.getElementById('feedback').classList.add('text-danger');
        document.getElementById('nextWord').style.display = 'block';
        disableWordButtons(true);
        document.getElementById('wordfortts').innerText = '';
    } else {
        document.getElementById('feedback').innerText = `Incorrect! Try again. Attempts left: ${maxIncorrectAttempts - incorrectAttempts}.`;
        document.getElementById('feedback').classList.add('text-danger');
    }
}

function nextWord() {
    incorrectAttempts = 0;
    document.getElementById('nextWord').style.display = 'none';
    document.getElementById('feedback').innerText = '';
    document.getElementById('feedback').classList.remove('text-success', 'text-danger');
    resetButtonsToLoading();
    generateWordsForTTS();
}
function disableWordButtons(disable) {
    const buttons = document.querySelectorAll('.btn.btn-primary');
    buttons.forEach(button => {
        button.disabled = disable;
    });
}
function resetButtonsToLoading() {
    const buttons = document.querySelectorAll('.btn.btn-primary');
    buttons.forEach(button => {
        button.innerText = 'Loading..';
        button.disabled = true;
    });
}
document.addEventListener('DOMContentLoaded', generateWordsForTTS);
</script> 
{% endblock %}

{% block scripts %}

<script src="{{ url_for('static', filename='js/ourcode.js') }}" defer></script>
{% endblock %}
