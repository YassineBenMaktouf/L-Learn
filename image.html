{% extends "mainfront/base.html" %}

{% block content %}
<div class="row justify-content-center mt-3">
    <div class="col-lg-6 col-md-8 col-sm-10">
        <div class="card mb-2">
            <div class="card-body" >
                <div class="page">
                    <div class="container py-5">
                        <div class="row">
                            <div class="col">
                                <h2 class="card-title text-center mb-4">What does the image represent?</h2>
                                <div id="image_div"></div>
                                <div  class="mt-4 mb-4 d-flex justify-content-center">
                                    <button id="word1" class="btn btn-primary btn-block mr-2" style="margin: 3px;">Loading..</button>
                                    <button id="word2" class="btn btn-primary btn-block mr-2" style="margin: 3px;">Loading..</button>
                                    <button id="word3" class="btn btn-primary btn-block mr-2" style="margin: 3px;">Loading..</button>
                                    <button id="word4" class="btn btn-primary btn-block mr-2" style="margin: 3px;">Loading..</button>
                                </div>
                                <div>
                                    <div id="feedback" class="mt-3 d-flex align-items-center justify-content-center" style="text-align: center;"></div>
                                </div>
                                <div class="mt-3 d-flex justify-content-center">
                                    <button id="nextImage" class="btn btn-secondary" style="display: block;" onclick="nextImage()">Next Image</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
// Function to generate image with random word
function generateImageWithRandomWord() {
    fetch('/generate_image_with_random_word')
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            console.log(data); // Log the response data
            if (data && data.message === 'Image generated successfully') {
                // Pass the words and the correct word to updateButtons
                updateButtons(data.words, data.correct_word); // Adjusted to include correct_word
                
                const img = document.createElement('img');
                // Append a unique timestamp to bypass cache
                img.src = './static/img/generated_image.png?' + new Date().getTime();
                img.classList.add('img-fluid', 'w-100', 'rounded');
                document.getElementById('image_div').innerHTML = ''; // Clear existing images
                document.getElementById('image_div').appendChild(img);

                // Show the Next Image button
                document.getElementById('nextImage').style.display = 'block';
            } else {
                console.error('Failed to generate image');
                document.getElementById('feedback').innerText = 'Failed to generate image.';
                document.getElementById('feedback').classList.add('text-danger');
                document.getElementById('feedback').classList.remove('text-success');
            }
        })
        .catch(error => {
            console.error('Error occurred during fetch:', error);
        });
}

// Adjusted updateButtons to include correct_word parameter
function updateButtons(words, correctWord) {
    const buttonContainer = document.querySelector('.mt-4.mb-4.d-flex');
    buttonContainer.innerHTML = ''; // Clear existing buttons to avoid duplicating event listeners

    if (words && words.length >= 4) {
        words.forEach((word) => {
            const button = document.createElement('button');
            button.innerText = word;
            button.classList.add('btn', 'btn-primary', 'btn-block', 'mr-2');
            button.style.margin = '3px';
            
            button.addEventListener('click', () => checkAnswer(word, correctWord)); // Use the actual correct word for comparison
            
            buttonContainer.appendChild(button);
        });
    } else {
        console.error('Words data is missing or insufficient');
    }
}

// Check if the selected word is correct
function checkAnswer(selectedWord, correctWord) {
    if (selectedWord === correctWord) {
        document.getElementById('feedback').innerText = 'Correct!';
        document.getElementById('feedback').classList.add('text-success');
        document.getElementById('feedback').classList.remove('text-danger');
    } else {
        document.getElementById('feedback').innerText = 'Incorrect!';
        document.getElementById('feedback').classList.add('text-danger');
        document.getElementById('feedback').classList.remove('text-success');
    }
}

// Function to load the next image
function nextImage() {
    // Hide the Next Image button immediately when clicked
    document.getElementById('nextImage').style.display = 'none';

    // Clear current image and feedback
    document.getElementById('image_div').innerHTML = '';
    document.getElementById('feedback').innerText = '';
    document.getElementById('feedback').classList.remove('text-success', 'text-danger');

    // Indicate loading for the word buttons, not the Next Image button
    const buttons = document.querySelectorAll('.btn.btn-primary'); // Ensure we only target the word buttons
    buttons.forEach(button => button.innerText = 'Loading..');

    // Call the function to generate a new image with random words
    generateImageWithRandomWord();
}

// Initial call to load the first image
document.addEventListener('DOMContentLoaded', generateImageWithRandomWord);

</script>

{% endblock %}